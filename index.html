<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>宿舍公约截图版</title>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
html, body {
    background-color: #f0f2f5;
    font-family: "Microsoft YaHei", sans-serif;
    margin: 0;
    padding: 0;
}
.capture-root {
    width: 900px;
    margin: 20px auto;
}
.card {
    background: #ffffff;
    padding: 24px;
    border-radius: 12px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    margin-bottom: 24px;
    box-sizing: border-box;
}
h1, h2 {
    text-align: center;
    margin: 0 0 8px 0;
}
h2 {
    border-bottom: 2px solid #4da3ff;
    padding-bottom: 4px;
}
.desc {
    text-align: center;
    font-size: 14px;
    color: #666;
    margin: 5px 0 15px;
}
.card table {
    border-collapse: collapse;
    width: 850px;
    table-layout: fixed;
    background-color: #fafcff;
    margin: 0 auto;
}
thead {
    background-color: #4da3ff;
    color: white;
}
.card th,
.card td {
    border: 1px solid #d0d7de;
    padding: 8px;
    text-align: center !important;
    vertical-align: middle;
    word-break: break-word;
    font-size: 14px;
}
textarea {
    width: 100%;
    min-height: 40px;
    resize: vertical;
    border: none;
    outline: none;
    padding: 4px;
    font-family: inherit;
    font-size: 14px;
    background-color: transparent;
    white-space: pre-wrap;
}
textarea:focus {
    background-color: #f1f9ff;
    box-shadow: inset 0 0 0 2px #6bb8ff;
}
.btn-container {
    text-align: center;
    margin: 0 auto 24px auto;
}
button {
    background: #4da3ff;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 12px 28px;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.3s;
}
button:hover {
    background: #1c86ff;
}
</style>
</head>
<body>

<div class="capture-root">
    <div class="card">
        <h1>十平米剧场：校园宿舍生活卡牌</h1>
        <h2>宿舍公约达成记录卡</h2>
        <p class="desc">请将各位玩家在决策事件中经过讨论后达成的方案记录在此</p>
        <table id="main-table">
            <colgroup>
                <col style="width:50px">
                <col>
                <col>
                <col>
            </colgroup>
            <thead>
                <tr>
                    <th>序号</th>
                    <th>事件名称</th>
                    <th>公约内容</th>
                    <th>宿舍成就</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="card">
        <h2>宿舍公约补充</h2>
        <p class="desc">可从公共生活、个人边界、作息生活、财务支配、社交冲突等方面讨论</p>
        <table id="extra-table">
            <colgroup>
                <col style="width:50px">
                <col>
            </colgroup>
            <thead>
                <tr>
                    <th>序号</th>
                    <th>我们的宿舍共识</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div class="btn-container">
    <button id="save-btn">提交并保存为高清图片</button>
</div>

<script>
function generateRows(tableId, rows, cols) {
    const tbody = document.querySelector(`#${tableId} tbody`);
    for (let i = 1; i <= rows; i++) {
        let tr = document.createElement("tr");
        for (let j = 0; j < cols; j++) {
            let td = document.createElement("td");
            if (j === 0) {
                td.textContent = i;
            } else {
                let ta = document.createElement("textarea");
                td.appendChild(ta);
            }
            tr.appendChild(td);
        }
        tbody.appendChild(tr);
    }
}
generateRows("main-table", 10, 4);
generateRows("extra-table", 5, 2);

/* 自动增高 textarea */
document.addEventListener("input", e => {
    if (e.target.tagName.toLowerCase() === "textarea") {
        e.target.style.height = "auto";
        e.target.style.height = e.target.scrollHeight + "px";
    }
});

/* 替换 textarea -> div，固化居中样式 */
function replaceTextareas(root) {
    const replacements = [];
    root.querySelectorAll("textarea").forEach(ta => {
        const cs = getComputedStyle(ta);
        const div = document.createElement("div");
        div.textContent = ta.value;
        div.style.whiteSpace = "pre-wrap";
        div.style.wordBreak = "break-word";
        div.style.minHeight = cs.minHeight;
        div.style.padding = cs.padding;
        div.style.font = cs.font;
        div.style.textAlign = "center";
        ta.parentNode.replaceChild(div, ta);
        replacements.push({div, ta});
    });
    return () => {
        replacements.forEach(({div, ta}) => {
            div.parentNode.replaceChild(ta, div);
        });
    };
}

document.getElementById("save-btn").onclick = async function () {
    const root = document.querySelector(".capture-root");
    const restore = replaceTextareas(root);

    const canvas = await html2canvas(root, {
        backgroundColor: "#f0f2f5",
        scale: 2,
        useCORS: true,
    });

    const imageData = canvas.toDataURL("image/png");

    // 本地保存
    const link = document.createElement("a");
    link.href = imageData;
    link.download = "宿舍公约.png";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    restore();
};
</script>
</body>
</html>
